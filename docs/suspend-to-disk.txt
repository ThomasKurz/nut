Desc: Using suspend to disk
File: suspend-to-disk.txt
Date: 29 December 2008
Auth: Arjen de Korte <adkorte-guest@alioth.debian.org>


Support for suspend to RAM and suspend to disk has been available in
the Linux kernel for a while now. For obvious reasons, suspending to
RAM isn't particularly useful when the UPS battery is getting low,
but suspend to disk may be an interesting concept.

This approach minimizes the amount of disruption which would be caused
by an extended outage.  The UPS goes on battery, then reaches low
battery, and the system takes a snapshot of itself and halts.  Then it
is turned off and waits for the power to return.

Once the power is back, the system reboots, pulls the snapshot back in,
and keeps going from there.  If the user happened to be away when it
happened, they may return and have no idea that their system actually
shut down completely in the middle.

In order for this to work, you need to shutdown NUT (UPS driver, upsd
server and upsmon client) in the suspend script and start them again in
the resume script.  Don't try to keep them running.  The upsd server
will latch the FSD state (so it won't be useable after resuming) and so
will the upsmon client.  Some drivers may work after resuming, but many
don't and some UPS'es will require re-initialization, so it's best not
to keep this running either.

After stopping driver, server and client you'll have to send the UPS
the command to shutdown only if the POWERDOWNFLAG is present.  Note
that most likely you'll have to allow for a grace period after sending 
'upsdrvctl shutdown' since the system will still have to take a
snapshot of itself after that.  Not all drivers support this, so before
going down this road, make sure that the one you're using does.